<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic CSV Generator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f8fafc;
            color: #1f2937;
            line-height: 1.6;
            margin: 0;
            height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark mode styles */
        body.dark-mode {
            background: #111827;
            color: #f9fafb;
        }

        body.dark-mode .sidebar {
            background: #1f2937;
            border-right-color: #374151;
        }

        body.dark-mode .main-content {
            background: #111827;
        }

        body.dark-mode .header {
            border-bottom-color: #374151;
        }

        body.dark-mode .header h1 {
            color: #f9fafb;
        }

        body.dark-mode .header p {
            color: #9ca3af;
        }

        body.dark-mode .sidebar-header h2 {
            color: #f9fafb;
        }

        body.dark-mode .icon-btn {
            background: #374151;
            border-color: #14b8a6;
            color: #14b8a6;
        }

        body.dark-mode .icon-btn:hover {
            background: #0f766e;
            color: #ffffff;
        }

        body.dark-mode .icon-btn-secondary {
            border-color: #6b7280;
            color: #9ca3af;
        }

        body.dark-mode .icon-btn-secondary:hover {
            background: #4b5563;
            color: #f9fafb;
        }

        body.dark-mode .page-tab {
            color: #d1d5db;
        }

        body.dark-mode .page-tab:hover {
            background: #374151;
        }

        body.dark-mode .page-tab.active {
            background: #0f766e;
            color: #ffffff;
        }

        body.dark-mode .page-action-btn {
            color: #9ca3af;
        }

        body.dark-mode .page-action-btn:hover {
            background: #4b5563;
            color: #f9fafb;
        }

        body.dark-mode .page-action-btn.danger:hover {
            background: #7f1d1d;
            color: #fca5a5;
        }

        body.dark-mode .generate-float {
            background: #1f2937;
            border-color: #374151;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .section {
            background: #1f2937;
            border-color: #374151;
        }

        body.dark-mode .section h2 {
            color: #f9fafb;
        }

        body.dark-mode .field-item {
            background: #374151;
            border-color: #4b5563;
        }

        body.dark-mode .field-item:hover {
            border-color: #14b8a6;
        }

        body.dark-mode .field-header span {
            color: #f9fafb;
        }

        body.dark-mode .input-group label {
            color: #d1d5db;
        }

        body.dark-mode .input-group input,
        body.dark-mode .input-group select,
        body.dark-mode .input-group textarea {
            background: #111827;
            border-color: #4b5563;
            color: #f9fafb;
        }

        body.dark-mode .input-group input:focus,
        body.dark-mode .input-group select:focus,
        body.dark-mode .input-group textarea:focus {
            border-color: #14b8a6;
        }

        body.dark-mode .checkbox-group label {
            color: #d1d5db;
        }

        body.dark-mode .btn {
            background: #374151;
            border-color: #14b8a6;
            color: #14b8a6;
        }

        body.dark-mode .btn:hover {
            background: #0f766e;
            color: #ffffff;
        }

        body.dark-mode .btn-danger {
            background: #374151;
            border-color: #dc2626;
            color: #fca5a5;
        }

        body.dark-mode .btn-danger:hover {
            background: #7f1d1d;
            color: #ffffff;
        }

        body.dark-mode .btn-generate {
            background: #14b8a6;
            color: #ffffff;
        }

        body.dark-mode .btn-generate:hover {
            background: #0f766e;
        }

        body.dark-mode .empty-state {
            background: #1f2937;
            border-color: #374151;
            color: #9ca3af;
        }

        body.dark-mode .empty-state h3 {
            color: #f9fafb;
        }

        body.dark-mode .enum-hint {
            color: #9ca3af;
        }

        /* Dark mode toggle button */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 26px;
            background: #374151;
            border: 2px solid #14b8a6;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 2px;
        }

        .dark-mode-toggle:hover {
            background: #4b5563;
        }

        .dark-mode-toggle::before {
            content: 'üåô';
            position: absolute;
            left: 4px;
            font-size: 14px;
            transition: opacity 0.3s ease;
        }

        .dark-mode-toggle::after {
            content: '‚òÄÔ∏è';
            position: absolute;
            right: 4px;
            font-size: 14px;
            transition: opacity 0.3s ease;
        }

        .dark-mode-toggle .toggle-slider {
            width: 20px;
            height: 20px;
            background: #14b8a6;
            border-radius: 50%;
            transition: transform 0.3s ease;
            transform: translateX(0);
        }

        body.dark-mode .dark-mode-toggle {
            background: #1f2937;
        }

        body.dark-mode .dark-mode-toggle .toggle-slider {
            transform: translateX(20px);
        }

        body.dark-mode .dark-mode-toggle::before {
            opacity: 0.5;
        }

        body.dark-mode .dark-mode-toggle::after {
            opacity: 1;
        }

        .dark-mode-toggle::before {
            opacity: 1;
        }

        .dark-mode-toggle::after {
            opacity: 0.5;
        }

        /* Sidebar footer */
        .sidebar-footer {
            margin-top: auto;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
            text-align: center;
        }

        .sidebar-footer p {
            color: #6b7280;
            font-size: 12px;
            font-weight: 400;
            margin: 0;
        }

        body.dark-mode .sidebar-footer {
            border-top-color: #374151;
        }

        body.dark-mode .sidebar-footer p {
            color: #9ca3af;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 320px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            padding: 24px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .main-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .container {
            max-width: none;
            margin: 0;
            background: transparent;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .header h1 {
            color: #1f2937;
            font-size: 1.5rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .header p {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 400;
        }

        .sidebar-section {
            margin-bottom: 32px;
        }

        .sidebar-section h2 {
            color: #1f2937;
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .sidebar-header h2 {
            color: #1f2937;
            font-size: 1.125rem;
            font-weight: 500;
            margin: 0;
        }

        .sidebar-controls {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #14b8a6;
            border-radius: 6px;
            background: #ffffff;
            color: #14b8a6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .icon-btn:hover {
            background: #f0fdfa;
        }

        .icon-btn-secondary {
            border-color: #6b7280;
            color: #6b7280;
        }

        .icon-btn-secondary:hover {
            background: #f9fafb;
        }

        .pages-navigation {
            background: transparent;
            border: none;
            padding: 0;
            margin-bottom: 0;
        }

        .pages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .pages-header h2 {
            color: #1f2937;
            font-size: 1.125rem;
            font-weight: 500;
            margin: 0;
        }

        .pages-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pages-tabs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .page-tab {
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            width: 100%;
            position: relative;
        }

        .page-tab:hover {
            background: #f0fdfa;
        }

        .page-tab.active {
            background: #f0fdfa;
            color: #14b8a6;
        }

        .page-title {
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .page-actions {
            display: none;
            gap: 4px;
            margin-left: auto;
        }

        .page-tab:hover .page-actions {
            display: flex;
        }

        .page-tab.active .page-actions {
            display: flex;
        }

        .page-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .page-action-btn:hover {
            background: #e5e7eb;
        }

        .page-action-btn.danger:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        .page-close {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .page-close:hover {
            color: #dc2626;
            background: #fef2f2;
        }

        .config-management {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .main-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: #f8fafc;
            position: relative;
        }

        .generate-float {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            align-items: end;
            gap: 16px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .generate-controls {
            display: flex;
            align-items: end;
            gap: 16px;
        }

        .generate-controls .input-group {
            margin: 0;
        }

        .generate-controls .input-group input {
            width: 100px;
            text-align: center;
        }

        .generate-controls .checkbox-group {
            margin: 0;
        }

        .btn-generate {
            background: #14b8a6;
            color: white;
            border: 1px solid #14b8a6;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-generate:hover {
            background: #0f766e;
            border-color: #0f766e;
        }

        .section {
            margin-bottom: 32px;
            padding: 24px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .section h2 {
            color: #1f2937;
            margin-bottom: 24px;
            font-size: 1.25rem;
            font-weight: 500;
        }

        .field-item {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s ease;
        }

        .field-item:hover {
            border-color: #14b8a6;
        }

        .field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .field-header span {
            font-weight: 500;
            color: #1f2937;
        }

        .field-controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 16px;
            align-items: end;
            margin-bottom: 16px;
        }

        .field-row {
            display: flex;
            gap: 16px;
            align-items: end;
            margin-bottom: 16px;
        }

        .field-row.full {
            display: block;
        }

        .field-row .input-group {
            flex: 1;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-group label {
            font-weight: 500;
            color: #374151;
            font-size: 13px;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 400;
            transition: border-color 0.2s ease;
            background: #ffffff;
            font-family: 'Poppins', sans-serif;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #14b8a6;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #14b8a6;
        }

        .checkbox-group label {
            font-weight: 400;
            color: #374151;
            cursor: pointer;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: 1px solid #14b8a6;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #ffffff;
            color: #14b8a6;
            font-family: 'Poppins', sans-serif;
            width: 100%;
            justify-content: center;
        }

        .btn:hover {
            background: #f0fdfa;
        }

        .btn-primary {
            border-color: #14b8a6;
            color: #14b8a6;
        }

        .btn-primary:hover {
            background: #f0fdfa;
        }

        .btn-secondary {
            border-color: #6b7280;
            color: #6b7280;
        }

        .btn-secondary:hover {
            background: #f9fafb;
        }

        .btn-danger {
            border-color: #dc2626;
            color: #dc2626;
            width: auto;
        }

        .btn-danger:hover {
            background: #fef2f2;
        }

        .btn-success {
            border-color: #14b8a6;
            color: #14b8a6;
            font-size: 16px;
            padding: 16px 32px;
            margin-top: 24px;
            width: auto;
        }

        .btn-success:hover {
            background: #f0fdfa;
        }

        .btn-info {
            border-color: #14b8a6;
            color: #14b8a6;
        }

        .btn-info:hover {
            background: #f0fdfa;
        }

        .add-field-btn {
            margin-bottom: 24px;
        }

        .records-section {
            text-align: center;
        }

        .records-input {
            font-size: 16px;
            text-align: center;
            max-width: 200px;
            margin: 0 auto;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .enum-hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
            font-weight: 400;
        }

        .file-input {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .empty-state h3 {
            margin-bottom: 12px;
            color: #374151;
            font-weight: 500;
        }

        .empty-state p {
            margin-bottom: 24px;
        }

        .empty-state .btn {
            width: auto;
        }

        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
                height: auto;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
                position: relative;
            }

            body.dark-mode .sidebar {
                border-bottom-color: #374151;
            }

            .main-content {
                padding: 16px;
            }

            .sidebar-controls {
                flex-direction: row;
                gap: 8px;
            }

            .pages-tabs {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .generate-float {
                position: relative;
                bottom: auto;
                right: auto;
                margin-top: 24px;
                box-shadow: none;
            }

            .generate-controls {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .field-controls {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .field-row {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .btn {
                width: 100%;
            }

            .btn-danger {
                width: auto;
            }

            .dark-mode-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 22px;
            }

            .dark-mode-toggle .toggle-slider {
                width: 16px;
                height: 16px;
            }

            body.dark-mode .dark-mode-toggle .toggle-slider {
                transform: translateX(16px);
            }

            .dark-mode-toggle::before,
            .dark-mode-toggle::after {
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <!-- Dark mode toggle -->
    <div class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
        <div class="toggle-slider"></div>
    </div>

    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="pages-navigation">
                    <div class="sidebar-header">
                        <h2>Pages</h2>
                        <div class="sidebar-controls">
                            <button class="icon-btn" onclick="createNewPage()" title="New Page">+</button>
                            <button class="icon-btn" onclick="downloadConfig()" title="Save Config">üíæ</button>
                            <button class="icon-btn icon-btn-secondary"
                                onclick="document.getElementById('configFileInput').click()"
                                title="Load Config">üìÅ</button>
                            <input type="file" id="configFileInput" class="file-input" accept=".json"
                                onchange="loadConfig(event)">
                        </div>
                    </div>
                    <div class="pages-tabs" id="pagesTabs"></div>
                </div>
            </div>

            <div class="sidebar-footer">
                <p>created by khribi9</p>
            </div>
        </div>

        <div class="main-content">
            <div class="container">
                <div id="pageContent">
                    <div class="section">
                        <h2>Field Configuration</h2>
                        <div class="add-field-btn">
                            <button class="btn btn-primary" onclick="addField()">+ Add Field</button>
                        </div>
                        <div id="fieldsContainer"></div>
                    </div>
                </div>

                <div id="emptyState" class="empty-state hidden">
                    <h3>No pages created yet</h3>
                    <p>Create your first page to start building CSV configurations</p>
                    <button class="btn btn-primary" onclick="createNewPage()">+ Create First Page</button>
                </div>
            </div>

            <div class="generate-float">
                <div class="generate-controls">
                    <div class="input-group">
                        <label for="recordCount">Records</label>
                        <input type="number" id="recordCount" min="1" max="100000" value="100">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeHeaders" checked>
                        <label for="includeHeaders">Include Headers</label>
                    </div>
                </div>
                <button class="btn-generate" onclick="generateCSV()">üöÄ Generate CSV</button>
            </div>
        </div>
    </div>

    <script>
        let currentPageId = null;
        let pages = {};
        let fieldCounters = {};

        // Initialize the application
        function initApp() {
            console.log('üöÄ Initializing CSV Generator...');

            // Load dark mode preference
            loadDarkModePreference();

            // Check localStorage availability
            if (typeof (Storage) === "undefined") {
                console.error('‚ùå localStorage is not supported by this browser');
                alert('Warning: Your browser does not support local storage. Data will not be saved.');
            } else {
                console.log('‚úÖ localStorage is available');
            }

            loadFromLocalStorage();
            setupAutoSave(); // Setup auto-save event listeners

            if (Object.keys(pages).length === 0) {
                console.log('üìù No pages found, showing empty state');
                showEmptyState();
            } else {
                console.log('üìÑ Found', Object.keys(pages).length, 'pages');
                hideEmptyState();
                renderPageTabs();
                const firstPageId = Object.keys(pages)[0];
                switchToPage(firstPageId);
            }
        }

        function showEmptyState() {
            document.getElementById('pageContent').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        function hideEmptyState() {
            document.getElementById('pageContent').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        function createNewPage() {
            const pageId = 'page_' + Date.now();
            const pageName = prompt('Enter page name:', `Page ${Object.keys(pages).length + 1}`);

            if (!pageName) return;

            pages[pageId] = {
                name: pageName,
                fields: [],
                recordCount: 100,
                includeHeaders: true
            };
            fieldCounters[pageId] = 0;

            hideEmptyState();
            renderPageTabs();
            switchToPage(pageId);
            saveToLocalStorage(); // Auto-save after creating new page
        }

        function renderPageTabs() {
            const tabsContainer = document.getElementById('pagesTabs');
            tabsContainer.innerHTML = '';

            Object.keys(pages).forEach(pageId => {
                const page = pages[pageId];
                const tab = document.createElement('div');
                tab.className = `page-tab ${pageId === currentPageId ? 'active' : ''}`;
                tab.onclick = () => switchToPage(pageId);

                tab.innerHTML = `
                    <span class="page-title" title="${page.name}">${page.name}</span>
                    <div class="page-actions">
                        <button class="page-action-btn" onclick="event.stopPropagation(); renamePage('${pageId}')" title="Rename">‚úèÔ∏è</button>
                        <button class="page-action-btn" onclick="event.stopPropagation(); duplicatePage('${pageId}')" title="Duplicate">üìã</button>
                        <button class="page-action-btn danger" onclick="event.stopPropagation(); deletePage('${pageId}')" title="Delete">√ó</button>
                    </div>
                `;

                tabsContainer.appendChild(tab);
            });
        }

        function switchToPage(pageId) {
            if (currentPageId) {
                saveCurrentPageData();
            }

            currentPageId = pageId;
            loadPageData(pageId);
            renderPageTabs();
            saveToLocalStorage(); // Auto-save after switching pages
        }

        function saveCurrentPageData() {
            if (!currentPageId || !pages[currentPageId]) return;

            const fieldsData = [];
            const fieldElements = document.querySelectorAll('.field-item');

            fieldElements.forEach(fieldElement => {
                const fieldId = fieldElement.id.split('-')[1];
                const fieldData = {
                    id: fieldId,
                    name: document.getElementById(`fieldName-${fieldId}`)?.value || '',
                    isRandom: document.getElementById(`isRandom-${fieldId}`)?.checked || false,
                    staticValue: document.getElementById(`staticInput-${fieldId}`)?.value || '',
                    dataType: document.getElementById(`dataType-${fieldId}`)?.value || 'string',
                    numberRange: document.getElementById(`numberRangeInput-${fieldId}`)?.value || '1-100',
                    booleanFormat: document.getElementById(`booleanFormatSelect-${fieldId}`)?.value || 'true-false',
                    enumValues: document.getElementById(`enumValues-${fieldId}`)?.value || ''
                };
                fieldsData.push(fieldData);
            });

            pages[currentPageId].fields = fieldsData;
            pages[currentPageId].recordCount = document.getElementById('recordCount')?.value || 100;
            pages[currentPageId].includeHeaders = document.getElementById('includeHeaders')?.checked || true;

            saveToLocalStorage();
        }

        function loadPageData(pageId) {
            const page = pages[pageId];
            if (!page) return;

            // Clear current fields
            document.getElementById('fieldsContainer').innerHTML = '';
            fieldCounters[pageId] = 0;

            // Load page fields
            page.fields.forEach(fieldData => {
                addFieldFromData(fieldData);
            });

            // Load page settings
            document.getElementById('recordCount').value = page.recordCount;
            document.getElementById('includeHeaders').checked = page.includeHeaders;
        }

        function addFieldFromData(fieldData) {
            const fieldId = fieldData.id;
            fieldCounters[currentPageId] = Math.max(fieldCounters[currentPageId], parseInt(fieldId));

            const fieldsContainer = document.getElementById('fieldsContainer');
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'field-item fade-in';
            fieldDiv.id = `field-${fieldId}`;

            fieldDiv.innerHTML = generateFieldHTML(fieldId);
            fieldsContainer.appendChild(fieldDiv);

            // Populate field data
            document.getElementById(`fieldName-${fieldId}`).value = fieldData.name;
            document.getElementById(`isRandom-${fieldId}`).checked = fieldData.isRandom;
            document.getElementById(`staticInput-${fieldId}`).value = fieldData.staticValue;
            document.getElementById(`dataType-${fieldId}`).value = fieldData.dataType;
            document.getElementById(`numberRangeInput-${fieldId}`).value = fieldData.numberRange;
            document.getElementById(`booleanFormatSelect-${fieldId}`).value = fieldData.booleanFormat;
            document.getElementById(`enumValues-${fieldId}`).value = fieldData.enumValues;

            toggleRandomOptions(fieldId);
        }

        function deletePage(pageId) {
            if (Object.keys(pages).length <= 1) {
                alert('Cannot delete the last page!');
                return;
            }

            if (!confirm('Are you sure you want to delete this page?')) return;

            delete pages[pageId];
            delete fieldCounters[pageId];

            if (currentPageId === pageId) {
                const remainingPages = Object.keys(pages);
                if (remainingPages.length > 0) {
                    switchToPage(remainingPages[0]);
                } else {
                    currentPageId = null;
                    showEmptyState();
                }
            }

            renderPageTabs();
            saveToLocalStorage(); // Auto-save after deleting page
        }

        function duplicatePage(pageId) {
            const sourcePageId = pageId || currentPageId;
            if (!sourcePageId) return;

            saveCurrentPageData();
            const sourcePage = pages[sourcePageId];
            const newPageId = 'page_' + Date.now();
            const newName = prompt('Enter name for duplicated page:', sourcePage.name + ' (Copy)');

            if (!newName) return;

            pages[newPageId] = JSON.parse(JSON.stringify(sourcePage));
            pages[newPageId].name = newName;
            fieldCounters[newPageId] = fieldCounters[sourcePageId];

            renderPageTabs();
            switchToPage(newPageId);
            saveToLocalStorage(); // Auto-save after duplicating page
        }

        function renamePage(pageId) {
            const targetPageId = pageId || currentPageId;
            if (!targetPageId) return;

            const newName = prompt('Enter new page name:', pages[targetPageId].name);
            if (!newName) return;

            pages[targetPageId].name = newName;
            renderPageTabs();
            saveToLocalStorage(); // Auto-save after renaming page
        }

        function addField() {
            if (!currentPageId) return;

            fieldCounters[currentPageId]++;
            const fieldId = fieldCounters[currentPageId];
            const fieldsContainer = document.getElementById('fieldsContainer');

            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'field-item fade-in';
            fieldDiv.id = `field-${fieldId}`;
            fieldDiv.innerHTML = generateFieldHTML(fieldId);

            fieldsContainer.appendChild(fieldDiv);
            toggleRandomOptions(fieldId);
            saveToLocalStorage(); // Auto-save after adding field
        }

        function generateFieldHTML(fieldId) {
            return `
                <div class="field-header">
                    <span>Field ${fieldId}</span>
                    <button class="btn btn-danger" onclick="removeField(${fieldId})">Remove</button>
                </div>
                
                <div class="field-controls">
                    <div class="input-group">
                        <label>Field Name</label>
                        <input type="text" id="fieldName-${fieldId}" placeholder="e.g., Name, Age, Email" required>
                    </div>
                    
                    <div class="input-group">
                        <label>Data Type</label>
                        <select id="dataType-${fieldId}" onchange="toggleEnumOptions(${fieldId})">
                            <option value="string">String</option>
                            <option value="number">Number</option>
                            <option value="email">Email</option>
                            <option value="date">Date</option>
                            <option value="boolean">Boolean</option>
                            <option value="enum">Enum (Custom List)</option>
                        </select>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="isRandom-${fieldId}" onchange="toggleRandomOptions(${fieldId})">
                        <label for="isRandom-${fieldId}">Random</label>
                    </div>
                </div>
                
                <div id="staticValue-${fieldId}" class="field-row full">
                    <div class="input-group">
                        <label>Static Value</label>
                        <input type="text" id="staticInput-${fieldId}" placeholder="Enter static value for all records">
                    </div>
                </div>
                
                <div id="randomOptions-${fieldId}" class="hidden">
                    <div class="field-row" id="numberRange-${fieldId}">
                        <div class="input-group">
                            <label>Number Range (min-max)</label>
                            <input type="text" id="numberRangeInput-${fieldId}" placeholder="1-100" value="1-100">
                        </div>
                    </div>
                    
                    <div class="field-row" id="booleanFormat-${fieldId}">
                        <div class="input-group">
                            <label>Boolean Format</label>
                            <select id="booleanFormatSelect-${fieldId}">
                                <option value="true-false">true/false</option>
                                <option value="1-0">1/0</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="enumOptions-${fieldId}" class="hidden">
                        <div class="input-group">
                            <label>Enum Values</label>
                            <textarea id="enumValues-${fieldId}" placeholder="Enter values separated by commas&#10;e.g., Red, Blue, Green, Yellow"></textarea>
                            <div class="enum-hint">Separate values with commas. Each value will be randomly selected.</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function removeField(fieldId) {
            const field = document.getElementById(`field-${fieldId}`);
            field.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                field.remove();
                saveCurrentPageData(); // Auto-save after removing field
            }, 300);
        }

        function toggleRandomOptions(fieldId) {
            const isRandom = document.getElementById(`isRandom-${fieldId}`).checked;
            const staticDiv = document.getElementById(`staticValue-${fieldId}`);
            const randomDiv = document.getElementById(`randomOptions-${fieldId}`);

            if (isRandom) {
                staticDiv.classList.add('hidden');
                randomDiv.classList.remove('hidden');
                toggleEnumOptions(fieldId);
            } else {
                staticDiv.classList.remove('hidden');
                randomDiv.classList.add('hidden');
            }

            // Auto-save after toggling random options
            setTimeout(() => saveCurrentPageData(), 100);
        }

        function toggleEnumOptions(fieldId) {
            const dataType = document.getElementById(`dataType-${fieldId}`).value;
            const enumDiv = document.getElementById(`enumOptions-${fieldId}`);
            const numberRangeDiv = document.getElementById(`numberRange-${fieldId}`);
            const booleanFormatDiv = document.getElementById(`booleanFormat-${fieldId}`);

            // Hide all conditional options first
            enumDiv.classList.add('hidden');
            numberRangeDiv.classList.add('hidden');
            booleanFormatDiv.classList.add('hidden');

            // Show relevant options based on data type
            if (dataType === 'enum') {
                enumDiv.classList.remove('hidden');
            } else if (dataType === 'number') {
                numberRangeDiv.classList.remove('hidden');
            } else if (dataType === 'boolean') {
                booleanFormatDiv.classList.remove('hidden');
            }

            // Auto-save after toggling enum options
            setTimeout(() => saveCurrentPageData(), 100);
        }

        function generateRandomValue(type, options = {}) {
            switch (type) {
                case 'string':
                    const names = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Henry', 'Ivy', 'Jack'];
                    return names[Math.floor(Math.random() * names.length)];

                case 'number':
                    const range = options.range || [1, 100];
                    return Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];

                case 'email':
                    const domains = ['gmail.com', 'yahoo.com', 'outlook.com', 'example.com'];
                    const usernames = ['user', 'test', 'demo', 'sample', 'example'];
                    const username = usernames[Math.floor(Math.random() * usernames.length)];
                    const domain = domains[Math.floor(Math.random() * domains.length)];
                    return `${username}${Math.floor(Math.random() * 1000)}@${domain}`;

                case 'date':
                    const start = new Date(2020, 0, 1);
                    const end = new Date();
                    const randomDate = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
                    return randomDate.toISOString().split('T')[0];

                case 'boolean':
                    const randomBoolean = Math.random() > 0.5;
                    const format = options.format || 'true-false';
                    if (format === '1-0') {
                        return randomBoolean ? 1 : 0;
                    } else {
                        return randomBoolean;
                    }

                case 'enum':
                    const values = options.values || ['Option1', 'Option2', 'Option3'];
                    return values[Math.floor(Math.random() * values.length)];

                default:
                    return 'Sample Value';
            }
        }

        function generateCSV() {
            if (!currentPageId) return;

            saveCurrentPageData();

            const recordCount = parseInt(document.getElementById('recordCount').value);
            const includeHeaders = document.getElementById('includeHeaders').checked;
            const fieldElements = document.querySelectorAll('.field-item');

            if (fieldElements.length === 0) {
                alert('Please add at least one field before generating CSV!');
                return;
            }

            if (!recordCount || recordCount < 1) {
                alert('Please enter a valid number of records!');
                return;
            }

            const fields = [];
            const headers = [];

            // Parse field configurations
            fieldElements.forEach(fieldElement => {
                const fieldId = fieldElement.id.split('-')[1];
                const fieldName = document.getElementById(`fieldName-${fieldId}`).value;
                const isRandom = document.getElementById(`isRandom-${fieldId}`).checked;

                if (!fieldName.trim()) {
                    alert('Please fill in all field names!');
                    throw new Error('Missing field name');
                }

                headers.push(fieldName);

                if (isRandom) {
                    const dataType = document.getElementById(`dataType-${fieldId}`).value;
                    const fieldConfig = { type: dataType, isRandom: true };

                    if (dataType === 'number') {
                        const rangeInput = document.getElementById(`numberRangeInput-${fieldId}`).value;
                        const rangeParts = rangeInput.split('-').map(x => parseInt(x.trim()));
                        if (rangeParts.length === 2 && !isNaN(rangeParts[0]) && !isNaN(rangeParts[1])) {
                            fieldConfig.range = rangeParts;
                        }
                    } else if (dataType === 'boolean') {
                        const booleanFormat = document.getElementById(`booleanFormatSelect-${fieldId}`).value;
                        fieldConfig.format = booleanFormat;
                    } else if (dataType === 'enum') {
                        const enumInput = document.getElementById(`enumValues-${fieldId}`).value;
                        if (!enumInput.trim()) {
                            alert('Please provide enum values for field: ' + fieldName);
                            throw new Error('Missing enum values');
                        }
                        fieldConfig.values = enumInput.split(',').map(v => v.trim()).filter(v => v);
                    }

                    fields.push(fieldConfig);
                } else {
                    const staticValue = document.getElementById(`staticInput-${fieldId}`).value;
                    fields.push({ type: 'static', value: staticValue, isRandom: false });
                }
            });

            // Generate CSV data
            const csvData = [];

            // Add headers only if the option is checked
            if (includeHeaders) {
                csvData.push(headers.join(','));
            }

            for (let i = 0; i < recordCount; i++) {
                const row = [];
                fields.forEach(field => {
                    let value;
                    if (field.isRandom) {
                        value = generateRandomValue(field.type, field);
                    } else {
                        value = field.value;
                    }

                    // Escape CSV values that contain commas or quotes
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }

                    row.push(value);
                });
                csvData.push(row.join(','));
            }

            // Download CSV
            const csvContent = csvData.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                const pageName = pages[currentPageId].name.replace(/[^a-z0-9]/gi, '_');
                link.setAttribute('download', `${pageName}_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Auto-save functionality - save immediately on any change
        function saveToLocalStorage() {
            try {
                const data = {
                    pages: pages,
                    fieldCounters: fieldCounters,
                    currentPageId: currentPageId,
                    darkMode: document.body.classList.contains('dark-mode'),
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('csvGeneratorData', JSON.stringify(data));
                console.log('‚úÖ Data saved to localStorage at:', data.lastSaved);

                // Test if data was actually saved
                const testData = localStorage.getItem('csvGeneratorData');
                if (!testData) {
                    console.error('‚ùå Failed to save data to localStorage');
                } else {
                    console.log('‚úÖ Data size:', Math.round(testData.length / 1024), 'KB');
                }
            } catch (error) {
                console.error('‚ùå Error saving to localStorage:', error);
                alert('Warning: Could not save data to browser storage. Your changes may be lost when you close the browser.');
            }
        }

        function saveCurrentPageData() {
            if (!currentPageId || !pages[currentPageId]) return;

            const fieldsData = [];
            const fieldElements = document.querySelectorAll('.field-item');

            fieldElements.forEach(fieldElement => {
                const fieldId = fieldElement.id.split('-')[1];
                const fieldData = {
                    id: fieldId,
                    name: document.getElementById(`fieldName-${fieldId}`)?.value || '',
                    isRandom: document.getElementById(`isRandom-${fieldId}`)?.checked || false,
                    staticValue: document.getElementById(`staticInput-${fieldId}`)?.value || '',
                    dataType: document.getElementById(`dataType-${fieldId}`)?.value || 'string',
                    numberRange: document.getElementById(`numberRangeInput-${fieldId}`)?.value || '1-100',
                    booleanFormat: document.getElementById(`booleanFormatSelect-${fieldId}`)?.value || 'true-false',
                    enumValues: document.getElementById(`enumValues-${fieldId}`)?.value || ''
                };
                fieldsData.push(fieldData);
            });

            pages[currentPageId].fields = fieldsData;
            pages[currentPageId].recordCount = document.getElementById('recordCount')?.value || 100;
            pages[currentPageId].includeHeaders = document.getElementById('includeHeaders')?.checked || true;

            saveToLocalStorage();
        }

        // Auto-save on input changes
        function setupAutoSave() {
            // Save on form input changes
            document.addEventListener('input', function (event) {
                if (event.target.matches('input, select, textarea')) {
                    debounce(() => {
                        saveCurrentPageData();
                    }, 500)();
                }
            });

            // Save on checkbox changes
            document.addEventListener('change', function (event) {
                if (event.target.matches('input[type="checkbox"]')) {
                    saveCurrentPageData();
                }
            });
        }

        // Debounce function to prevent excessive saves
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function loadFromLocalStorage() {
            console.log('üîÑ Loading data from localStorage...');
            const savedData = localStorage.getItem('csvGeneratorData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    pages = data.pages || {};
                    fieldCounters = data.fieldCounters || {};
                    currentPageId = data.currentPageId;

                    // Load dark mode preference
                    if (data.darkMode) {
                        document.body.classList.add('dark-mode');
                    }

                    console.log('‚úÖ Data loaded from localStorage:', {
                        pageCount: Object.keys(pages).length,
                        lastSaved: data.lastSaved,
                        currentPageId: currentPageId,
                        darkMode: data.darkMode
                    });

                    // Validate currentPageId exists in pages
                    if (currentPageId && !pages[currentPageId]) {
                        currentPageId = Object.keys(pages)[0] || null;
                    }
                } catch (e) {
                    console.error('‚ùå Error loading from localStorage:', e);
                    pages = {};
                    fieldCounters = {};
                    currentPageId = null;
                }
            } else {
                console.log('‚ÑπÔ∏è No saved data found in localStorage');
                pages = {};
                fieldCounters = {};
                currentPageId = null;
            }
        }

        // Config export/import functions
        function downloadConfig() {
            if (currentPageId) {
                saveCurrentPageData();
            }

            const config = {
                pages: pages,
                fieldCounters: fieldCounters,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], {
                type: 'application/json;charset=utf-8;'
            });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `csv_generator_config_${new Date().toISOString().slice(0, 10)}.json`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function loadConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const config = JSON.parse(e.target.result);

                    if (!config.pages) {
                        alert('Invalid configuration file format!');
                        return;
                    }

                    // Ask user if they want to merge or replace
                    const hasExistingData = Object.keys(pages).length > 0;
                    let shouldReplace = true;

                    if (hasExistingData) {
                        shouldReplace = confirm(
                            'Do you want to replace all existing pages?\n\n' +
                            'Click OK to replace all pages\n' +
                            'Click Cancel to merge with existing pages'
                        );
                    }

                    if (shouldReplace) {
                        pages = {};
                        fieldCounters = {};
                        currentPageId = null;
                    }

                    // Import pages
                    Object.keys(config.pages).forEach(pageId => {
                        let newPageId = pageId;

                        // If merging and pageId exists, create new unique ID
                        if (!shouldReplace && pages[pageId]) {
                            newPageId = 'page_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        }

                        pages[newPageId] = config.pages[pageId];
                        fieldCounters[newPageId] = config.fieldCounters[pageId] || 0;
                    });

                    // Set current page
                    if (!currentPageId || !pages[currentPageId]) {
                        currentPageId = Object.keys(pages)[0] || null;
                    }

                    if (currentPageId) {
                        hideEmptyState();
                        renderPageTabs();
                        switchToPage(currentPageId);
                    } else {
                        showEmptyState();
                    }

                    saveToLocalStorage();
                    alert('Configuration loaded successfully!');

                } catch (error) {
                    console.error('Error loading config:', error);
                    alert('Error loading configuration file. Please check the file format.');
                }
            };

            reader.readAsText(file);
            // Reset file input
            event.target.value = '';
        }

        // Auto-save functionality - no longer needed as we have real-time saving
        // setInterval(() => {
        //     if (currentPageId) {
        //         saveCurrentPageData();
        //     }
        // }, 10000); // Auto-save every 10 seconds

        // Save data before page unload
        window.addEventListener('beforeunload', () => {
            console.log('üîÑ Page unloading, saving data...');
            if (currentPageId) {
                saveCurrentPageData();
            }
        });

        // Test localStorage functionality
        function testLocalStorage() {
            try {
                const testKey = 'csvGeneratorTest';
                const testValue = 'test_' + Date.now();

                // Test write
                localStorage.setItem(testKey, testValue);

                // Test read
                const retrieved = localStorage.getItem(testKey);

                // Test delete
                localStorage.removeItem(testKey);

                if (retrieved === testValue) {
                    console.log('‚úÖ localStorage test passed');
                    return true;
                } else {
                    console.error('‚ùå localStorage test failed: read/write mismatch');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå localStorage test failed:', error);
                return false;
            }
        }

        // Add debugging info to console
        window.addEventListener('load', () => {
            console.log('üîç Browser Storage Debug Info:');
            console.log('Browser:', navigator.userAgent);
            console.log('localStorage supported:', typeof (Storage) !== "undefined");
            console.log('localStorage test:', testLocalStorage());

            // Check current storage usage
            if (typeof (Storage) !== "undefined") {
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length;
                    }
                }
                console.log('localStorage usage:', Math.round(totalSize / 1024), 'KB');

                // Check our specific data
                const ourData = localStorage.getItem('csvGeneratorData');
                if (ourData) {
                    console.log('Our data size:', Math.round(ourData.length / 1024), 'KB');
                } else {
                    console.log('No existing data found');
                }
            }
        });

        // Dark mode functionality
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            console.log('üåì Dark mode toggled:', isDarkMode ? 'ON' : 'OFF');

            // Save preference
            saveToLocalStorage();
        }

        function loadDarkModePreference() {
            // Check if user has a saved preference
            const savedData = localStorage.getItem('csvGeneratorData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.darkMode) {
                        document.body.classList.add('dark-mode');
                    }
                } catch (e) {
                    // If parsing fails, check system preference
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.body.classList.add('dark-mode');
                    }
                }
            } else {
                // No saved preference, check system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-mode');
                }
            }
        }

        // Initialize the application
        initApp();
    </script>
</body>

</html>
